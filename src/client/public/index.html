<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Example</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet-src.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    #map { height: 100vh; }
    #error { 
      position: absolute; 
      top: 10px; 
      left: 10px; 
      z-index: 1000; 
      background: white; 
      padding: 10px; 
      border-radius: 5px; 
      display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="error"></div>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const map = L.map('map').setView([51.505, -0.09], 13);
      const errorDiv = document.getElementById('error');

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      const limit = 1000;
      let offset = 0;

      const getColor = (freq) => {
        return freq >= 10 ? 'red' :
               freq >= 5 && freq <= 9 ? 'orange' :
               freq >= 1 && freq <= 4 ? 'yellow' :
                           'green';
      };

      const styleFeature = (feature) => {
        return {
          fillColor: getColor(feature.properties.freq),
          weight: 2,
          opacity: 1,
          color: 'white',
          fillOpacity: 0.7
        };
      };

      const fetchData = async () => {
        try {
          const response = await axios.get('/data', {
            params: { limit, offset }
          });
          const data = response.data;
          console.log('Data retrieved:', data);

          data.forEach(item => {
            try {
              const geoJSON = JSON.parse(item.geometry);
              geoJSON.properties = { freq: item.freq };
              console.log('Parsed GeoJSON:', geoJSON);

              L.geoJSON(geoJSON, {
                style: styleFeature
              }).addTo(map)
                .bindPopup(`Frequency: ${item.freq}`)
                .openPopup();
            } catch (error) {
              console.error('Error parsing GeoJSON:', error);
            }
          });

          if (data.length === limit) {
            offset += limit;
            fetchData();
          } else {
            console.log('All data fetched');
          }
        } catch (error) {
          console.error('Error fetching data:', error);
          errorDiv.textContent = `Error fetching data: ${error.message}`;
          errorDiv.style.display = 'block';
        }
      };

      fetchData();
    });
  </script>
</body>
</html>